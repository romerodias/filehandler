<?php 
/**
* @copyright (c) 2014, rdtecnologia.com.br  
* @license MIT Licence 
*/
 session_start(); set_time_limit(230); require 'util/Util.php'; require 'config/Config.php'; ini_set('memory_limit', '500M'); date_default_timezone_set('America/Sao_Paulo'); header('Content-Type:text/html; charset=utf-8'); header("Cache-Control: no-store, no-cache, must-revalidate"); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Cache-Control: post-check=0, pre-check=0", false); header("Pragma: no-cache"); $class = trim($_REQUEST['classe']); $metodo = trim($_REQUEST['metodo']); $argumento = $_REQUEST; $argumento['exporter'] = '698dc19d489c4e4db73e28a713eab07b'; $argumento['getAll'] = 1; $arrColunas = explode('-', $argumento['i']); $arrColunasHeader = explode('-', $argumento['h']); unset($argumento['classe'], $argumento['metodo']); foreach($argumento as $key => $value) { if(preg_match('/ext-/', $key)) unset($argumento[$key]); if($key == 'PHPSESSID') unset($argumento[$key]); } $url = Config::getValue('APP', 'url'); $httpGet = 'http://'.$url.'/service/' .$class . '/' . $metodo . '?' . http_build_query($argumento); $teste = file_get_contents($httpGet); $arr = json_decode($teste, true); header("Cache-Control: no-cache, must-revalidate"); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Content-type: application/vnd.ms-excel"); header("Content-type: application/force-download"); header("Content-Disposition: attachment; filename=" . str_replace('/', '_', $class) . ".xls"); function numberParseToptBr($value) { if(preg_match('/^\d{0,}\.\d{1,}$/', trim($value))) return str_replace('.', ',', $value); else return $value; } function numberToText($v) { if(preg_match('/^0{1,}/', trim($v))) return sprintf("'%s", trim($v)); return $v; } function format($v){ return $v; } if (! $arr) $arr = array(); $arrStatus = array(); if (array_key_exists('rows', $arr)) $arr = $arr['rows']; echo '<table border="1">'; echo '<thead><tr>'; foreach($arrColunasHeader as $header) { echo '<td><b>' . $header . '</b></td>'; } echo '</tr></thead>'; $rows = array(); if($arr['rows']){ $rows = $arr['rows']; } else { $rows = $arr; } foreach($rows as $arrList) { echo '<tbody><tr>'; foreach($arrColunas as $coluna) { echo '<td>' . utf8_decode(format($arrList[$coluna])) . '</td>'; } echo '</tr></tbody>'; } echo '<tfoot><tr><td colspan="' . count($arrColunasHeader) . '">'; if ($arrStatus) { $arrQtdStatus = array_count_values($arrStatus); foreach($arrQtdStatus as $k => $v) { echo sprintf('%s (<b>%s</b>)  ', utf8_decode($k), $v); } } echo '</td></tr></tfoot>'; echo '</table>';